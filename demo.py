# 定义状态
from typing import TypedDict, Literal

from langgraph.graph import StateGraph


# 定义邮件分类结构
class EmailClassification(TypedDict):
    intent: Literal['question', 'bug', 'billing', 'feature','complex']
    urgency: Literal['low', 'medium', 'high','critical']
    topic: str
    summary: str

# 定义读取
class EmailAgentState(TypedDict):
    email_content: str
    sender_email: str
    email_id: str

    # Classification result
    classification: EmailClassification | None

    # Raw search/API results
    search_results: list[str] | None  # List of raw document chunks
    customer_history: dict | None  # Raw customer data from CRM

    # Generated content
    draft_response: str | None
    messages: list[str] | None

# from langgraph.types import RetryPolicy
#
# workflow.add_node(
#     "search_documentation",
#     search_documentation,
#     retry_policy=RetryPolicy(max_attempts=3, initial_interval=1.0)
# )

from langgraph.checkpoint.memory import MemorySaver
from langgraph.types import RetryPolicy

# Create the graph
workflow = StateGraph(EmailAgentState)

# Add nodes with appropriate error handling
workflow.add_node("read_email", read_email)
workflow.add_node("classify_intent", classify_intent)

# Add retry policy for nodes that might have transient failures
workflow.add_node(
    "search_documentation",
    search_documentation,
    retry_policy=RetryPolicy(max_attempts=3)
)
workflow.add_node("bug_tracking", bug_tracking)
workflow.add_node("draft_response", draft_response)
workflow.add_node("human_review", human_review)
workflow.add_node("send_reply", send_reply)

# Add only the essential edges
workflow.add_edge(START, "read_email")
workflow.add_edge("read_email", "classify_intent")
workflow.add_edge("send_reply", END)

# Compile with checkpointer for persistence, in case run graph with Local_Server --> Please compile without checkpointer
memory = MemorySaver()
app = workflow.compile(checkpointer=memory)